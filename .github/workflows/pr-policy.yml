name: PR Policy

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  policy:
    runs-on: ubuntu-latest
    steps:
      - name: Check milestone and tests present
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            if (!pr) {
              core.setFailed('No PR context')
              return
            }
            // Require milestone
            if (!pr.milestone) {
              core.setFailed('PR must have a milestone assigned')
              return
            }
            // Require at least one test file changed in the PR (tests-first discipline)
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            })
            // Escape hatch via label and audit line in body
            const labels = (pr.labels || []).map(l => typeof l === 'string' ? l : l.name)
            const skip = labels.includes('skip-test-check')
            if (skip && /skip-test-check:/i.test(pr.body || '')) {
              core.notice('tests-first check skipped via label + audit line')
              return
            }
            // Allowlist infra/docs only changes
            const infraOnly = files.every(f => (
              f.filename.startsWith('.github/') ||
              /\.(ya?ml|md|txt)$/.test(f.filename) ||
              /(^|\/)Dockerfile$/.test(f.filename) ||
              /(^|\/)package-lock\.json$/.test(f.filename)
            ))
            if (infraOnly) {
              core.notice('infra/docs-only change: tests change not required')
              return
            }
            const hasTest = files.some(f => /__tests__|\.test\.[tj]sx?$/.test(f.filename))
            if (!hasTest) {
              core.setFailed('PR must include changes to tests (tests-first).')
              return
            }
            // Optional: Encourage acceptance criteria section
            const body = pr.body || ''
            if (!/Acceptance Criteria/i.test(body)) {
              core.notice('Consider adding an "Acceptance Criteria" section to the PR description.')
            }
